<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NavSmart</title>
    <style>
    body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: #f4f4f9;
        color: #333;
        height: 100vh;
        display: flex;
        flex-direction: column;
    }

    .header, .footer {
        text-align: center;
        padding: 20px;
        background-color: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    form {
        margin-top: 10px;
        display: flex;
        justify-content: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    input[type="file"] {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    button {
        padding: 12px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 1em;
        cursor: pointer;
    }

    .main-container {
        flex: 1;
        display: flex;
        flex-direction: row;
        padding: 20px;
        gap: 20px;
    }

    .left-panel {
        flex: 1;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        padding: 20px;
        overflow: auto;
    }

    #map {
        height: 100%;
        width: 100%;
        border-radius: 4px;
        background-color: #e9e9e9;
    }
    
    #chatbot form {
        margin-top: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .right-panel {
        flex: 1;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* Chatbot main layout */
    #chatbot {
        display: flex;
        flex-direction: column;
        height: 100%;
        background-color: #f9f9f9;
        position: relative;
    }

    /* Scrollable chat + itinerary content */
    #chatContent {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        margin-bottom: 70px;
    }

    /* Buttons bar at the bottom */
    #chatControls {
        position: sticky;
        bottom: 0;
        left: 0;
        width: 100%;
        display: flex;
        justify-content: center; /* center the buttons group */
        gap: 40px; /* space between buttons */
        padding: 10px;
        background-color: #ffffff;
        border-top: 1px solid #ddd;
        z-index: 10;
        box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);
    }

    #chatControls button {
        width: 45%; 
        max-width: 220px; 
        padding: 12px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 1em;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
    }

    #chatControls button:hover {
        background-color: #0056b3;
    }

    #chatControls button:active {
        transform: scale(0.97);
    }


    </style>
</head>
<body>

    <div class="header">
        <h1>NavSmart</h1>
        <h3>AI based Itinerary Planning and Navigation App</h3>
    </div>

    <div class="main-container">
        <div class="left-panel">
            <div id="map"></div>
        </div>

        <!-- Right panel for chatbot & itinerary -->
        <div class="right-panel">
            <div id="chatbot">
                <div id="chatContent">
                    <h3>AI Itinerary Assistant</h3>
                    <p><strong>Chatbot:</strong> How can I assist you with your travel plans?</p>
                    <div id="transcription" style="font-style: italic; color: #555;"></div>

                    <div id="itineraryDisplay">
                        <h4>Your Itinerary</h4>
                        <ul id="itineraryList"></ul>
                    </div>
                </div>

                <!-- Buttons at the bottom -->
                <div id="chatControls">
                    <button id="micBtn">üéôÔ∏è Speak Destination</button>
                    <button id="itineraryBtn">üß≠ Generate Itinerary</button>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <h5>A primitive prototype by team Nav-E-Gators</h5>
    </div>
    




    <script>
        let map, directionsService, directionsRenderer, transcriptionDiv;

        function initMap() {
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();

            const initialLocation = { lat: 22.5726, lng: 88.3638 }; // Kolkata
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 7,
                center: initialLocation,
            });
            directionsRenderer.setMap(map);
        }
        window.initMap = initMap;

        document.addEventListener('DOMContentLoaded', () => {
            transcriptionDiv = document.getElementById('transcription');

            document.getElementById('micBtn').addEventListener('click', startVoiceRecognition);
            document.getElementById('itineraryBtn').addEventListener('click', () => {
                const message = getCleanMessage();
                fetchItinerary(message);
            });
        });

        function startVoiceRecognition() {
            transcriptionDiv.textContent = 'üéôÔ∏è Listening...';

            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'en-US';
            recognition.start();

            recognition.onresult = async (event) => {
                const spokenText = event.results[0][0].transcript;
                transcriptionDiv.textContent = `You said: "${spokenText}"`;
                fetchRoute(spokenText);
            };

            recognition.onerror = (event) => {
                transcriptionDiv.textContent = `Error: ${event.error}`;
            };
        }

        function getCleanMessage() {
            return transcriptionDiv.textContent.replace('You said: "', '').replace('"', '');
        }

        async function fetchRoute(message) {
            try {
                const response = await fetch('/location/get-route', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                const data = await response.json();
                displayRoute(data);
            } catch (error) {
                transcriptionDiv.textContent = `Route error: ${error.message}`;
            }
        }

        function displayRoute(data) {
            const start = data.start;
            const end = data.end;

            if (start.error || end.error) {
                let errorMessage = "Could not plot route. ";
                if (start.error) errorMessage += `Start location error: ${start.error}. `;
                if (end.error) errorMessage += `End location error: ${end.error}.`;
                alert(errorMessage);
                return;
            }

            const startLatLng = new google.maps.LatLng(start.latitude, start.longitude);
            const endLatLng = new google.maps.LatLng(end.latitude, end.longitude);

            directionsService.route({
                origin: startLatLng,
                destination: endLatLng,
                travelMode: google.maps.TravelMode.DRIVING,
            }, (response, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(response);
                } else {
                    window.alert('Directions request failed due to ' + status);
                }
            });
        }

        async function fetchItinerary(message) {
            try {
                const response = await fetch('/location/get-itinerary', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                const data = await response.json();
                if (data.itinerary && Array.isArray(data.itinerary)) {
                    data.itinerary.forEach(day => {
                        displayItinerary(data);
                        addItineraryMarkers(data.itinerary);
                    });
                } else {
                    transcriptionDiv.textContent = 'Could not generate itinerary.';
                }
            } catch (error) {
                transcriptionDiv.textContent = `Itinerary error: ${error.message}`;
            }
        }

        function displayItinerary(data) {
            const itineraryList = document.getElementById('itineraryList');
            itineraryList.innerHTML = ''; // Clear previous

            if (data.itinerary) {
                data.itinerary.forEach(day => {
                    const item = document.createElement('li');
                    item.innerHTML = `<strong>${day.day} - ${day.location}</strong><br>${day.activities.join(', ')}`;
                    itineraryList.appendChild(item);
                });

                transcriptionDiv.textContent = data.reply;
            } else {
                transcriptionDiv.textContent = 'Could not generate itinerary.';
            }
        }

        function addItineraryMarkers(itinerary) {
            const geocoder = new google.maps.Geocoder();

            itinerary.forEach(day => {
                geocoder.geocode({ address: day.location }, (results, status) => {
                    if (status === 'OK') {
                        new google.maps.Marker({
                            map: map,
                            position: results[0].geometry.location,
                            title: `${day.day}: ${day.location}`
                        });
                    }
                });
            });
        }
    </script>
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDgJKSce1dwXMTZ886PDMqjaJrF9z1ErA&callback=initMap"></script>
</body>
</html>